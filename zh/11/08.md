---
title: è½¬ç§»åƒµå°¸
actions: ['checkAnswer', 'hints']
requireLogin: true
material:
  editor:
    language: javascript
    startingCode:
        "test/CryptoZombies.js": |
            const CryptoZombies = artifacts.require("CryptoZombies");
            const utils = require("./helpers/utils");
            const zombieNames = ["Zombie 1", "Zombie 2"];
            contract("CryptoZombies", (accounts) => {
                let [alice, bob] = accounts;
                let contractInstance;
                beforeEach(async () => {
                    contractInstance = await CryptoZombies.new();
                });
                it("should be able to create a new zombie", async () => {
                    const result = await contractInstance.createPseudoRandomZombie(zombieNames[0], {from: alice});
                    assert.equal(result.receipt.status, true);
                    assert.equal(result.logs[0].args.name,zombieNames[0]);
                })
                it("should not allow two zombies", async () => {
                    await contractInstance.createPseudoRandomZombie(zombieNames[0], {from: alice});
                    await utils.shouldThrow(contractInstance.createPseudoRandomZombie(zombieNames[1], {from: alice}));
                })

                // start here
            })
        "test/helpers/utils.js": |
            async function shouldThrow(promise) {
            try {
                await promise;
                assert(true);
            }
            catch (err) {
                return;
            }
            assert(false, "The contract did not throw.");

            }

            module.exports = {
                shouldThrow,
            };
    answer: >
        const CryptoZombies = artifacts.require("CryptoZombies");

        const utils = require("./helpers/utils");

        const zombieNames = ["Zombie 1", "Zombie 2"];

        contract("CryptoZombies", (accounts) => {
            let [alice, bob] = accounts;
            let contractInstance;
            beforeEach(async () => {
                contractInstance = await CryptoZombies.new();
            });
            it("should be able to create a new zombie", async () => {
                const result = await contractInstance.createPseudoRandomZombie(zombieNames[0], {from: alice});
                assert.equal(result.receipt.status, true);
                assert.equal(result.logs[0].args.name,zombieNames[0]);
            })
            it("should not allow two zombies", async () => {
                await contractInstance.createPseudoRandomZombie(zombieNames[0], {from: alice});
                await utils.shouldThrow(contractInstance.createPseudoRandomZombie(zombieNames[1], {from: alice}));
            })
            xcontext("with the single-step transfer scenario", async () => {
                it("should transfer a zombie", async () => {
                  // TODO: Test the single-step transfer scenario.
                })
            })
            xcontext("with the two-step transfer scenario", async () => {
                it("should approve and then transfer a zombie when the approved address calls transferForm", async () => {
                  // TODO: Test the two-step scenario.  The approved address calls transferFrom
                })
                it("should approve and then transfer a zombie when the owner calls transferForm", async () => {
                    // TODO: Test the two-step scenario.  The owner calls transferFrom
                 })
            })
        })
---
æé—® â€”â€” å‡å¦‚ Alice æƒ³æŠŠå¥¹çš„åƒµå°¸å‘é€ç»™ Bob. æˆ‘ä»¬è¦å¯¹å…¶æµ‹è¯•å—ï¼Ÿ

å½“ç„¶ï¼

å¦‚æœä½ ä¸€ç›´æœ‰ä¸Šå‰é¢çš„è¯¾ï¼Œé‚£ä¹ˆä½ åº”è¯¥çŸ¥é“ï¼Œæˆ‘ä»¬çš„åƒµå°¸ç»§æ‰¿è‡ª _ERC721_ã€‚_ERC721_ è§„èŒƒæœ‰ä¸¤ç§ä¸åŒçš„æ–¹æ³•æ¥è½¬ç§»ä»£å¸:

**(1)**
```sol
function transferFrom(address _from, address _to, uint256 _tokenId) external payable;
```

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ _Alice_ï¼ˆå…¶ä¸»äººï¼‰è°ƒç”¨ `transferFrom`ï¼Œå¥¹çš„ `address` ä½œä¸º `_from` å‚æ•°ï¼ŒBob çš„ `address` ä½œä¸º `_to` å‚æ•°ï¼Œä»¥åŠå¥¹æƒ³è¦è½¬ç§»çš„ `zombieId`ã€‚

**(2)**
```sol
function approve(address _approved, uint256 _tokenId) external payable;
```

ç„¶å

```sol
function transferFrom(address _from, address _to, uint256 _tokenId) external payable;
```

ç¬¬äºŒç§æ–¹æ³•æ˜¯ï¼Œ Alice é¦–å…ˆç”¨ Bob çš„åœ°å€å’Œ `zombieId` è°ƒç”¨ `approve` ã€‚ç„¶åï¼Œåˆçº¦å­˜å‚¨äº†æ‰¹å‡† Bob å¸¦èµ°åƒµå°¸çš„ä¿¡æ¯ã€‚æ¥ä¸‹æ¥ï¼Œå½“ Alice æˆ– Bob è°ƒç”¨ `transferFrom` æ—¶ï¼Œåˆçº¦æ£€æŸ¥è¯¥ `msg.sender` æ˜¯å¦ç­‰äº Alice æˆ– Bob çš„åœ°å€ã€‚å¦‚æœæ˜¯ï¼Œå®ƒå°†æŠŠåƒµå°¸è½¬ç§»ç»™ Bobã€‚

 æˆ‘ä»¬å°†è¿™ä¸¤ç§è½¬ç§»åƒµå°¸çš„æ–¹å¼ç§°ä¸ºâ€œåœºæ™¯â€ã€‚ä¸ºäº†æµ‹è¯•æ¯ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸¤ä¸ªä¸åŒçš„æµ‹è¯•ç»„ï¼Œå¹¶ä¸ºå®ƒä»¬æœ‰æ„ä¹‰çš„æè¿°ã€‚

ä¸ºä»€ä¹ˆç»™å®ƒä»¬åˆ†ç»„ï¼Ÿæˆ‘ä»¬åªæœ‰ä¸å¤šå‡ ä¸ªæµ‹è¯•å•Šâ€¦â€¦

æ˜¯çš„ï¼Œç°åœ¨æˆ‘ä»¬çš„é€»è¾‘å¾ˆç®€å•ï¼Œä½†æƒ…å†µå¹¶ä¸æ€»æ˜¯è¿™æ ·ã€‚ç¬¬äºŒç§åœºæ™¯ï¼ˆå³ `transferFrom` ä¹‹å‰çš„ `approve`ï¼‰ä¾ç„¶éœ€è¦è‡³å°‘ä¸¤ä¸ªæµ‹è¯•:

-   é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»æ£€æŸ¥ Alice è‡ªå·±æ˜¯å¦èƒ½å¤Ÿè½¬ç§»åƒµå°¸ã€‚

-   å…¶æ¬¡ï¼Œæˆ‘ä»¬è¿˜è¦æ£€æŸ¥æ˜¯å¦å…è®¸ Bob è¿è¡Œ `transferFrom`ã€‚

æ­¤å¤–ï¼Œä»¥åä½ å¯èƒ½æƒ³æ·»åŠ éœ€è¦ä¸åŒæµ‹è¯•çš„å…¶ä»–åŠŸèƒ½ã€‚æˆ‘ä»¬è®¤ä¸ºæœ€å¥½æ˜¯ä»ä¸€å¼€å§‹å°±è®¾ç½®ä¸€ä¸ªå¯æ‰©å±•ç»“æ„ ğŸ˜‰ã€‚è®©å…¶ä»–äººæ›´å®¹æ˜“ç†è§£ä½ çš„ä»£ç ï¼Œä¹Ÿè®©è¿‡äº†å¾ˆä¹…ä¹‹åçš„ä½ è‡ªå·±æ›´å®¹æ˜“ç†è§£ã€‚

>æ³¨æ„ï¼šå¦‚æœåæ¥ä½ ä¸å…¶ä»–ç¨‹åºå‘˜ä¸€èµ·åˆä½œï¼Œä½ ä¼šå‘ç°ä»–ä»¬æ›´æœ‰å¯èƒ½éµå¾ªä½ åœ¨åˆå§‹ä»£ç ä¸­åˆ¶å®šçš„ä»»ä½•çº¦å®šã€‚å¦‚æœä½ æƒ³åšæˆä¸€ä¸ªå¤§é¡¹ç›®ï¼Œæœ‰æ•ˆçš„åˆä½œæ˜¯ä½ éœ€è¦çš„å…³é”®æŠ€èƒ½ä¹‹ä¸€ã€‚æœ‰äº†è¿™äº›èƒ½å¸®åŠ©ä½ å°½æ—©å®ç°çš„è‰¯å¥½ä¹ æƒ¯ï¼Œä½ çš„ç¨‹åºå‘˜ç”Ÿæ¶¯ä¼šæ›´è½»æ¾ã€ä¹Ÿä¼šèµ°å¾—æ›´è¿œã€‚

## context å‡½æ•°

å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç»„ï¼Œ _Truffle_ æä¾›äº†ä¸€ä¸ªå«åš `context` çš„å‡½æ•°ã€‚æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨å®ƒæ¥æ›´å¥½åœ°ç»„ç»‡æˆ‘ä»¬çš„ä»£ç :

```javascript
context("with the single-step transfer scenario", async () => {
    it("should transfer a zombie", async () => {
      // TODO: Test the single-step transfer scenario.
    })
})

context("with the two-step transfer scenario", async () => {
    it("should approve and then transfer a zombie when the approved address calls transferForm", async () => {
      // TODO: Test the two-step scenario.  The approved address calls transferFrom
    })
    it("should approve and then transfer a zombie when the owner calls transferForm", async () => {
        // TODO: Test the two-step scenario.  The owner calls transferFrom
     })
})
```

å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªæ·»åŠ åˆ°æˆ‘ä»¬çš„ `CryptoZombies.js` æ–‡ä»¶ï¼Œç„¶åè¿è¡Œ `truffle test`ï¼Œè¾“å‡ºä¼šåƒè¿™æ ·:

```bash
Contract: CryptoZombies
    âœ“ should be able to create a new zombie (100ms)
    âœ“ should not allow two zombies (251ms)
    with the single-step transfer scenario
      âœ“ should transfer a zombie
    with the two-step transfer scenario
      âœ“ should approve and then transfer a zombie when the owner calls transferForm
      âœ“ should approve and then transfer a zombie when the approved address calls transferForm


  5 passing (2s)
```

å‘ƒ...

å†çœ‹ä¸€ä¸‹ â€”â€” ä¸Šé¢çš„è¾“å‡ºæœ‰ä¸ªé—®é¢˜ã€‚çœ‹èµ·æ¥æ‰€æœ‰çš„æµ‹è¯•éƒ½é€šè¿‡äº†ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ ¹æœ¬å°±è¿˜æ²¡æœ‰å†™å®ƒä»¬!!

å¹¸å¥½ï¼Œæœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆ â€”â€” å¦‚æœæˆ‘ä»¬åœ¨ `context()` å‡½æ•°å‰é¢åŠ ä¸Šä¸€ä¸ª `x`ï¼Œåƒè¿™æ ·ï¼š`xcontext()`ï¼Œé‚£ä¹ˆ `Truffle` å°†è·³è¿‡é‚£äº›æµ‹è¯•ã€‚

>æ³¨æ„ï¼š`x` ä¹Ÿå¯ä»¥æ”¾åœ¨ `it()` å‡½æ•°å‰é¢ã€‚å½“ç¼–å†™å®Œè¿™äº›å‡½æ•°çš„æµ‹è¯•æ—¶ï¼Œä¸è¦å¿˜è®°åˆ é™¤æ‰€æœ‰çš„ x å“¦!

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è¿è¡Œ `truffle test`ã€‚è¾“å‡ºä¼šåƒè¿™æ ·ï¼š

```
Contract: CryptoZombies
    âœ“ should be able to create a new zombie (199ms)
    âœ“ should not allow two zombies (175ms)
    with the single-step transfer scenario
      - should transfer a zombie
    with the two-step transfer scenario
      - should approve and then transfer a zombie when the owner calls transferForm
      - should approve and then transfer a zombie when the approved address calls transferForm


  2 passing (827ms)
  3 pending
```

å…¶ä¸­â€œ-â€è¡¨ç¤ºä½¿ç”¨äº†â€œxâ€æ ‡è®°è·³è¿‡çš„æµ‹è¯•ã€‚

å¾ˆå‰å®³ï¼Œå¯¹å§ï¼Ÿç°åœ¨ä½ å¯ä»¥ä¸€è¾¹è¿è¡Œæµ‹è¯•ï¼Œä¸€è¾¹æ ‡è®°å‡ºä¸ä¹…ä¹‹åéœ€è¦ç¼–å†™æµ‹è¯•çš„ç©ºå‡½æ•°ã€‚

# å®æˆ˜æ¼”ä¹ 
1. å¤åˆ¶/ç²˜è´´ä¸Šé¢çš„ä»£ç ã€‚

2. æˆ‘ä»¬æš‚æ—¶å…ˆ _è·³è¿‡_ `context` æ–°å‡½æ•°ã€‚

æˆ‘ä»¬çš„æµ‹è¯•åªæ˜¯ç©º shellï¼Œä¸ºäº†å®ç°å®ƒä»¬éœ€è¦ç¼–å†™å¤§é‡çš„é€»è¾‘ã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ†æ®µè®²è§£ã€‚
