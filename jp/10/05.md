---
title: 定義ファイル
actions: ['答え合わせ', 'ヒント']
requireLogin: true
material:
  editor:
    language: javascript
    startingCode:
      "truffle.js": |

        //1. Initialize `truffle-hdwallet-provider`

        // Set your own mnemonic here
        const mnemonic = "YOUR_MNEMONIC";

        // Module exports to make this configuration available to Truffle itself
        module.exports = {
          // Object with configuration for each network
          networks: {
            // Configuration for mainnet
            mainnet: {
              provider: function () {
                // Setting the provider with the Infura Mainnet address and Token
                return new HDWalletProvider(mnemonic, "https://mainnet.infura.io/v3/YOUR_TOKEN")
              },
              network_id: "1"
            },
            // Configuration for rinkeby network
            rinkeby: {
              // Special function to setup the provider
              provider: function () {
                // Setting the provider with the Infura Rinkeby address and Token
                return new HDWalletProvider(mnemonic, "https://rinkeby.infura.io/v3/YOUR_TOKEN")
              },
              network_id: //Fill in the `network_id` for the Rinkeby network.
            }
          }
        }; 
      
    answer: |

      const HDWalletProvider = require("truffle-hdwallet-provider");

      // Set your own mnemonic here
      const mnemonic = "YOUR_MNEMONIC";

      // Module exports to make this configuration available to Truffle itself
      module.exports = {
        // Object with configuration for each network
        networks: {
          // Configuration for mainnet
          mainnet: {
            provider: function () {
              // Setting the provider with the Infura Mainnet address and Token
              return new HDWalletProvider(mnemonic, "https://mainnet.infura.io/v3/YOUR_TOKEN")
            },
            network_id: "1"
          },
          // Configuration for rinkeby network
          rinkeby: {
            // Special function to setup the provider
            provider: function () {
              // Setting the provider with the Infura Rinkeby address and Token
              return new HDWalletProvider(mnemonic, "https://rinkeby.infura.io/v3/YOUR_TOKEN")
            },
            // Network id is 4 for Rinkeby
            network_id: 4
          }
        }
      };
---

素晴らしい！ソースコードのコンパイルに成功して、マイグレーションファイルを作ったぞ。

デプロイする前にもうひとつだけやるべきことが残っておる。定義ファイルを編集して、 **Truffle** にデプロイ先のネットワークを伝えるのだ。

待てよ。 **_Ethereum_** のネットワークは1つだと思っていたが。何か見逃しているんじゃないか？

## Ethereum Test Networks

**_Ethereum_** のテスト用ネットワークがいくつか公開されており、メインネットへデプロイする前に、お前のコントラクトを無料でテストさせてくれるのだ(メインネットにコントラクトをデプロイすると、変更できなくなってしまうことを思い出すのだ)。これらのテスト用ネットワークはメインネットとは異なるコンセンサスアルゴリズム（PoAなど）を使用しているから、テストを実行するためのイーサを自由に使えるぞ。

このレッスンでは、Rinkebyというネットワークを使うぞ。イーサリアム財団によって作られた、テスト用の公開ネットワークだ。

## 定義ファイル truffle.js 

さあ、デフォルトの **Truffle** 定義ファイルを見てみよう:

```bash
$ cat truffle.js
/*
 * NB: since truffle-hdwallet-provider 0.0.5 you must wrap HDWallet providers in a
 * function when declaring them. Failure to do so will cause commands to hang. ex:
 *
 * mainnet: {
 *     provider: function() {
 *       return new HDWalletProvider(mnemonic, 'https://mainnet.infura.io/<infura-key>')
 *     },
 *     network_id: '1',
 *     gas: 4500000,
 *     gasPrice: 10000000000,
 *   },
 */
```

ただの空のシェルだ。従って、我々はこのファイルを編集し、Rinkebyとイーサリアムのメインネットにコントラクトをデプロイできるようにしなければならない。

### Truffle's HD Wallet Provider

チャプター2を覚えているか？

追加で`truffle-hdwallet-provider`というパッケージをインストールし、 **Truffle** が取引に署名できるようにしただろう。

定義ファイルを編集して、`HDWalletProvider`を使うようにするぞ。ファイルの先頭に次の行を追加するのだ:

```JavaScript
const HDWalletProvider = require("truffle-hdwallet-provider");
```

次に、ニーモニックを保存するための変数を作成するぞ:

```JavaScript
const mnemonic = "onions carrots beans ...";
```

ニーモニックや秘密鍵といった機密情報を定義ファイルに直書きすることは推奨しておらぬぞ。

なぜかって？

定義ファイルはGitHubにプッシュされることが多く、そこでは誰もが見ることができるからだ。攻撃され放題ではないか😱！ニーモニック（または秘密鍵も！）が晒されることを防ぐためには、`.gitignore`に追加されたファイルから読み取るのだ。どうやるかは後で見せてやろう。

**今回のケースではシンプルに**、ニーモニックをコピーして変数に格納することとする。

### Rinkebyとイーサリアムのメインネット向けにTruffleをセットアップする

次に、デプロイ先のネットワークを **Truffle** に「知らせる」ために、２つのオブジェクトを作成しなければならない - １つはRinkeby向け、もう１つは **_イーサリアム_** のメインネット向けだ:

```JavaScript
networks: {
  // Configuration for mainnet
  mainnet: {
    provider: function () {
      // Setting the provider with the Infura Mainnet address and Token
      return new HDWalletProvider(mnemonic, "https://mainnet.infura.io/v3/YOUR_TOKEN")
    },
    network_id: "1"
  },
  // Configuration for rinkeby network
  rinkeby: {
    // Special function to setup the provider
    provider: function () {
      // Setting the provider with the Infura Rinkeby address and Token
      return new HDWalletProvider(mnemonic, "https://rinkeby.infura.io/v3/YOUR_TOKEN")
    },
    // Network id is 4 for Rinkeby
    network_id: 4
  }
```

> 注: providerはfunctionでラップされていて、必要になるまで初期化されることはない。

### まとめ

さあ、これまでの内容を合体し、定義ファイルがどのようになったか見てみよう:

```JavaScript
// Initialize HDWalletProvider
const HDWalletProvider = require("truffle-hdwallet-provider");

// Set your own mnemonic here
const mnemonic = "YOUR_MNEMONIC";

// Module exports to make this configuration available to Truffle itself
module.exports = {
  // Object with configuration for each network
  networks: {
    // Configuration for mainnet
    mainnet: {
      provider: function () {
        // Setting the provider with the Infura Mainnet address and Token
        return new HDWalletProvider(mnemonic, "https://mainnet.infura.io/v3/YOUR_TOKEN")
      },
      network_id: "1"
    },
    // Configuration for rinkeby network
    rinkeby: {
      // Special function to setup the provider
      provider: function () {
        // Setting the provider with the Infura Rinkeby address and Token
        return new HDWalletProvider(mnemonic, "https://rinkeby.infura.io/v3/YOUR_TOKEN")
      },
      // Network id is 4 for Rinkeby
      network_id: 4
    }
  }
};
```

# さあテストだ

先に定義ファイルを更新しておいてやった。欠けているピースを埋めるのだ:

1. ファイルの先頭に、`truffle-hdwallet-provider` を初期化するコードを追加せよ。

2. Rinkeby向けの`network_id`を埋めよ。覚えていなければ上のコードスニペットを参照するといい。
